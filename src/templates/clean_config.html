{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Column Configuration</h2>
    <p class="text-muted">Select how each column should be processed.</p>

    <form method="post">
        <div class="card mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50px;">Include</th>
                                <th>Column Name</th>
                                <th>Data Type</th>
                                <th>Output Format</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for col in columns %}
                            <tr>
                                <td class="text-center align-middle">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" name="include_{{ col }}"
                                            checked>
                                    </div>
                                </td>
                                <td class="align-middle fw-bold">{{ col }}</td>
                                <td>
                                    <select class="form-select type-select" name="type_{{ col }}" data-col="{{ col }}">
                                        <option value="Text">Text</option>
                                        <option value="Number" {% if 'amount' in col.lower() or 'price' in col.lower()
                                            or 'val' in col.lower() %}selected{% endif %}>Number</option>
                                        <option value="Date" {% if 'date' in col.lower() or 'time' in col.lower()
                                            %}selected{% endif %}>Date</option>
                                        <option value="Boolean" {% if 'active' in col.lower() or 'flag' in col.lower()
                                            %}selected{% endif %}>Boolean</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-select format-select" name="format_{{ col }}"
                                        id="format_{{ col }}">
                                        <!-- Options populated by JS -->
                                        <option value="">(None)</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mb-5">
            <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Back</button>
            <button type="submit" class="btn btn-success btn-lg">Clean Data & Preview</button>
        </div>
    </form>
</div>

<script>
    const formats = {
        'Text': [],
        'Number': ['0.00', '0', '0.000', '0.0000'],
        'Date': ['YYYY-MM-DD', 'DD/MM/YYYY', 'MM/DD/YYYY', 'DD-MMM-YYYY'],
        'Boolean': []
    };

    function updateFormats(select) {
        const type = select.value;
        const col = select.dataset.col;
        const formatSelect = document.getElementById(`format_${col}`);

        // Save current selection if possible
        const currentVal = formatSelect.value;

        formatSelect.innerHTML = '<option value="">(None)</option>';

        if (formats[type]) {
            formats[type].forEach(fmt => {
                const option = document.createElement('option');
                option.value = fmt;
                option.text = fmt;
                formatSelect.appendChild(option);
            });
        }

        // Restore selection if it exists in new options, otherwise default to first
        if (type === 'Number') formatSelect.value = '0.00';
        else if (type === 'Date') formatSelect.value = 'YYYY-MM-DD';
    }

    // Initialize
    document.querySelectorAll('.type-select').forEach(select => {
        select.addEventListener('change', (e) => updateFormats(e.target));
        updateFormats(select); // Initial run
    });
</script>
{% endblock %}